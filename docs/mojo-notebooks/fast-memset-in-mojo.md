pre {
  overflow-y: auto;
  max-height: 500px;
}

# Mojo 快速 memset

在本教程中，我们将使用 Mojo 的自动调优功能来实现一个针对小尺寸优化的 memset 版本。该实现的思想基于 Nadav Rotem 的工作\[[1](https://github.com/nadavrot/memset_benchmark)\]，并且在\[[2](https://storage.googleapis.com/pub-tools-public-publication-data/pdf/4f7c3da72d557ed418828823a8e59942859d677f.pdf)\]中也有很好的描述。下面简要总结这种方法。

## 高级概述

为了获得最佳的 memset 性能，我们希望使用尽可能宽的寄存器宽度进行内存访问。例如，如果我们想存储19个字节，我们希望使用向量宽度16并使用两个重叠的存储器。要存储9个字节，我们将使用两个8字节存储器。

然而，在我们实际进行存储之前，我们需要执行尺寸（size）检查，以确保我们处于正确的范围内。即，对于尺寸为8-16的数据，我们希望使用8字节存储器，对于尺寸为16-32的数据，我们希望使用16字节存储器，依此类推。

执行尺寸检查的顺序会显著影响性能，理想情况下，我们希望对最常出现的尺寸运行尽可能少的检查。例如，如果我们看到的大部分大小是16-32，那么我们希望首先检查是否在这个范围内，然后再检查是否在8-16或其他范围内。

这导致了许多不同的比较 “树 (trees)”，可以用于执行尺寸检查，在本教程中，我们使用 Mojo 的自动调优功能，根据输入数据的分布选择最优的比较树。

## 实现

我们将像往常一样从导入和类型别名开始。

```python
from autotune import autotune_fork, search
from utils.list import VariadicList
from math import min, max
from memory.unsafe import DTypePointer, Pointer
from time import now
from memory import memset as stdlib_memset

alias ValueType = UInt8
alias BufferPtrType = DTypePointer[DType.uint8]

alias memset_fn_type = fn(BufferPtrType, ValueType, Int) -> None
```

现在让我们添加一些辅助函数。我们将使用它们来对各种 memset 实现进行基准测试并可视化结果。

```python
fn measure_time(
    func: memset_fn_type, size: Int, ITERS: Int, SAMPLES: Int
) -> Int:
    alias alloc_size = 1024 * 1024
    let ptr = BufferPtrType.alloc(alloc_size)

    var best = -1
    for sample in range(SAMPLES):
        let tic = now()
        for iter in range(ITERS):
            # Offset pointer to shake up cache a bit
            let offset_ptr = ptr.offset((iter * 128) & 1024)

            # Just in case compiler will try to outsmart us and avoid repeating
            # memset, change the value we're filling with
            let v = ValueType(iter&255)

            # Actually call the memset function
            func(offset_ptr, v.value, size)

        let toc = now()
        if best < 0 or toc - tic < best:
            best = toc - tic

    ptr.free()
    return best

alias MULT = 2_000

fn visualize_result(size: Int, result: Int):
    print_no_newline("Size: ")
    if size < 10:
        print_no_newline(" ")
    print_no_newline(size, "  |")
    for _ in range(result // MULT):
        print_no_newline("*")
    print()


fn benchmark(func: memset_fn_type, title: StringRef):
    print("\n=====================")
    print(title)
    print("---------------------\n")

    alias benchmark_iterations = 30 * MULT
    alias warmup_samples = 10
    alias benchmark_samples = 1000

    # Warmup
    for size in range(35):
        _ = measure_time(
            func, size, benchmark_iterations, warmup_samples
        )

    # Actual run
    for size in range(35):
        let result = measure_time(
            func, size, benchmark_iterations, benchmark_samples
        )

        visualize_result(size, result)
```

## 再现论文中的结果

在 Mojo 中实现论文中的一个 memset 版本，并将其与系统的 memset 进行比较。

```python
@always_inline
fn overlapped_store[
    width: Int
](ptr: BufferPtrType, value: ValueType, count: Int):
    let v = SIMD.splat[DType.uint8, width](value)
    ptr.simd_store[width](v)
    ptr.simd_store[width](count - width, v)


fn memset_manual(ptr: BufferPtrType, value: ValueType, count: Int):
    if count < 32:
        if count < 5:
            if count == 0:
                return
            # 0 < count <= 4
            ptr.store(0, value)
            ptr.store(count - 1, value)
            if count <= 2:
                return
            ptr.store(1, value)
            ptr.store(count - 2, value)
            return

        if count <= 16:
            if count >= 8:
                # 8 <= count < 16
                overlapped_store[8](ptr, value, count)
                return
            # 4 < count < 8
            overlapped_store[4](ptr, value, count)
            return

        # 16 <= count < 32
        overlapped_store[16](ptr, value, count)
    else:
        # 32 < count
        memset_system(ptr, value, count)


fn memset_system(ptr: BufferPtrType, value: ValueType, count: Int):
    stdlib_memset(ptr, value.value, count)
```

对以上实现的 memset 版本与标准的 memset 进行基准测试。

> *__注意__：我们正在优化最小尺寸的 memset，并且正确地对其进行基准测试是棘手的。笔记本环境使其变得更加困难，虽然我们尽力调整笔记本以展示性能差异，但很难保证结果在每次运行时都是稳定的。*

```python
benchmark(memset_manual, "Manual memset")
benchmark(memset_system, "System memset")
```

```
=====================
Manual memset
---------------------

Size:  0   |******************************************
Size:  1   |******************************************
Size:  2   |******************************************
Size:  3   |******************************************
Size:  4   |******************************************
Size:  5   |***************************************************
Size:  6   |***************************************************
Size:  7   |***************************************************
Size:  8   |******************************************
Size:  9   |******************************************
Size: 10   |******************************************
Size: 11   |******************************************
Size: 12   |******************************************
Size: 13   |******************************************
Size: 14   |******************************************
Size: 15   |******************************************
Size: 16   |******************************************
Size: 17   |************************************************************
Size: 18   |************************************************************
Size: 19   |************************************************************
Size: 20   |************************************************************
Size: 21   |************************************************************
Size: 22   |************************************************************
Size: 23   |************************************************************
Size: 24   |************************************************************
Size: 25   |************************************************************
Size: 26   |************************************************************
Size: 27   |************************************************************
Size: 28   |************************************************************
Size: 29   |************************************************************
Size: 30   |************************************************************
Size: 31   |************************************************************
Size: 32   |********************************************************************
Size: 33   |********************************************************************
Size: 34   |********************************************************************

=====================
System memset
---------------------

Size:  0   |************************************************************
Size:  1   |************************************************************
Size:  2   |************************************************************
Size:  3   |************************************************************
Size:  4   |************************************************************
Size:  5   |************************************************************
Size:  6   |************************************************************
Size:  7   |************************************************************
Size:  8   |************************************************************
Size:  9   |************************************************************
Size: 10   |************************************************************
Size: 11   |************************************************************
Size: 12   |************************************************************
Size: 13   |************************************************************
Size: 14   |************************************************************
Size: 15   |************************************************************
Size: 16   |************************************************************
Size: 17   |************************************************************
Size: 18   |************************************************************
Size: 19   |************************************************************
Size: 20   |************************************************************
Size: 21   |************************************************************
Size: 22   |************************************************************
Size: 23   |************************************************************
Size: 24   |************************************************************
Size: 25   |************************************************************
Size: 26   |************************************************************
Size: 27   |************************************************************
Size: 28   |************************************************************
Size: 29   |************************************************************
Size: 30   |************************************************************
Size: 31   |************************************************************
Size: 32   |***************************************************
Size: 33   |***************************************************
Size: 34   |***************************************************    
```

## 调整不同尺寸的实现

我们可以看到对于小的尺寸来说，它已经快得多了。那个版本是针对特定的输入尺寸分布进行优化的，例如，我们可以看到尺寸为8-16和0-4的情况下工作最快。

但是，如果在我们的使用情况下分布是不同的呢？假设在我们的情况下，最常见的尺寸是16-32 - 这个版本是我们可以使用的最优版本吗？答案显然是“不”，我们可以很容易地调整实现，使其更适合这些尺寸 - 我们只需要将相应的检查移动到函数的开头。例如：

```python
fn memset_manual_2(ptr: BufferPtrType, value: ValueType, count: Int):
    if count < 32:
        if count >= 16:
            # 16 <= count < 32
            overlapped_store[16](ptr, value, count)
            return

        if count < 5:
            if count == 0:
                return
            # 0 < count <= 4
            ptr.store(0, value)
            ptr.store(count - 1, value)
            if count <= 2:
                return
            ptr.store(1, value)
            ptr.store(count - 2, value)
            return

        if count >= 8:
            # 8 <= count < 16
            overlapped_store[8](ptr, value, count)
            return
        # 4 < count < 8
        overlapped_store[4](ptr, value, count)

    else:
        # 32 < count
        memset_system(ptr, value, count)
```

让我们来检查一下这个版本的性能吧。

```python
benchmark(memset_manual_2, "Manual memset v2")
benchmark(memset_system, "Mojo system memset")
```

```
=====================
Manual memset v2
---------------------

Size:  0   |************************************************************
Size:  1   |************************************************************
Size:  2   |************************************************************
Size:  3   |***************************************************
Size:  4   |***************************************************
Size:  5   |************************************************************
Size:  6   |************************************************************
Size:  7   |************************************************************
Size:  8   |***************************************************
Size:  9   |***************************************************
Size: 10   |***************************************************
Size: 11   |***************************************************
Size: 12   |***************************************************
Size: 13   |***************************************************
Size: 14   |***************************************************
Size: 15   |***************************************************
Size: 16   |**********************************
Size: 17   |**********************************
Size: 18   |**********************************
Size: 19   |**********************************
Size: 20   |**********************************
Size: 21   |**********************************
Size: 22   |**********************************
Size: 23   |**********************************
Size: 24   |**********************************
Size: 25   |**********************************
Size: 26   |**********************************
Size: 27   |**********************************
Size: 28   |**********************************
Size: 29   |**********************************
Size: 30   |**********************************
Size: 31   |**********************************
Size: 32   |********************************************************************
Size: 33   |********************************************************************
Size: 34   |********************************************************************

=====================
Mojo system memset
---------------------

Size:  0   |************************************************************
Size:  1   |************************************************************
Size:  2   |************************************************************
Size:  3   |************************************************************
Size:  4   |************************************************************
Size:  5   |************************************************************
Size:  6   |************************************************************
Size:  7   |************************************************************
Size:  8   |************************************************************
Size:  9   |************************************************************
Size: 10   |************************************************************
Size: 11   |************************************************************
Size: 12   |************************************************************
Size: 13   |************************************************************
Size: 14   |************************************************************
Size: 15   |************************************************************
Size: 16   |************************************************************
Size: 17   |************************************************************
Size: 18   |************************************************************
Size: 19   |************************************************************
Size: 20   |************************************************************
Size: 21   |************************************************************
Size: 22   |************************************************************
Size: 23   |************************************************************
Size: 24   |************************************************************
Size: 25   |************************************************************
Size: 26   |************************************************************
Size: 27   |************************************************************
Size: 28   |************************************************************
Size: 29   |************************************************************
Size: 30   |************************************************************
Size: 31   |************************************************************
Size: 32   |***************************************************
Size: 33   |***************************************************
Size: 34   |***************************************************
```

这个16-32尺寸上的性能现在好多了！

问题是我们不得不手动重写代码。如果可以自动完成这个工作岂不是很好？

在 Mojo 中，这是可能的（而且非常容易） - 我们可以生成多个实现，让编译器为我们选择最快的实现，并在我们想要的尺寸上评估它们！

## Mojo 实现

让我们深入探讨一下。

首先，我们需要生成所有可能的候选项。为了做到这一点，我们需要迭代地生成尺寸检查，以了解我们可以使用哪个重叠存储的尺寸。一旦我们确定了尺寸区间，我们只需调用相应尺寸的重叠存储。

为了表达这一点，我们将实现一个自适应函数 `memset_impl_layer`，该函数有两个参数，用于指定当前可能大小值的区间。当我们生成一个新的尺寸检查时，我们将该区间分为两部分，并在这两部分上递归调用相同的函数。一旦我们达到最小的区间，我们将调用相应的重叠存储函数。

这个第一个实现涵盖了最小区间的情况：

```python
@adaptive
@always_inline
fn memset_impl_layer[
    lower: Int, upper: Int
](ptr: BufferPtrType, value: ValueType, count: Int):
    @parameter
    if lower == -100 and upper == 0:
        pass
    elif lower == 0 and upper == 4:
        ptr.store(0, value)
        ptr.store(count - 1, value)
        if count <= 2:
            return
        ptr.store(1, value)
        ptr.store(count - 2, value)
    elif lower == 4 and upper == 8:
        overlapped_store[4](ptr, value, count)
    elif lower == 8 and upper == 16:
        overlapped_store[8](ptr, value, count)
    elif lower == 16 and upper == 32:
        overlapped_store[16](ptr, value, count)
    elif lower == 32 and upper == 100:
        memset_system(ptr, value, count)
    else:
        constrained[False]()
```

让我们现在为另一种情况添加一个实现，即我们需要生成一个尺寸检查。

```python
@adaptive
@always_inline
fn memset_impl_layer[
    lower: Int, upper: Int
](ptr: BufferPtrType, value: ValueType, count: Int):
    alias cur: Int
    autotune_fork[Int, 0, 4, 8, 16, 32 -> cur]()

    constrained[cur > lower]()
    constrained[cur < upper]()

    if count > cur:
        memset_impl_layer[max(cur, lower), upper](ptr, value, count)
    else:
        memset_impl_layer[lower, min(cur, upper)](ptr, value, count)
```

在这里，我们使用 `autotune_fork` 来生成在该点可能的所有检查。

我们将丢弃当前区间之外的值，并对区间内的值进行递归调用此函数来进行区间拆分。

这足以生成多个正确的 memset 版本，但要实现最佳性能，我们需要考虑另一个因素：当处理如此小的尺寸时，甚至代码位置也非常重要。例如，如果我们交换 Then 和 Else 分支并反转条件，可能会得到最终函数的不同性能。

为了考虑到这一点，让我们再添加一个函数的实现，但是现在交换分支：

```python
@adaptive
@always_inline
fn memset_impl_layer[
    lower: Int, upper: Int
](ptr: BufferPtrType, value: ValueType, count: Int):
    alias cur: Int
    autotune_fork[Int, 0, 4, 8, 16, 32 -> cur]()

    constrained[cur > lower]()
    constrained[cur < upper]()

    if count <= cur:
        memset_impl_layer[lower, min(cur, upper)](ptr, value, count)
    else:
        memset_impl_layer[max(cur, lower), upper](ptr, value, count)
```

我们已经为我们的实现定义了构建块，现在我们需要添加一个顶级入口点，以启动我们刚刚定义的递归。

我们将简单地用 [-100,100] 的区间调用我们的函数，-100和100只是表示尚未进行任何检查。随着我们生成更多的检查，这个区间将被细化，直到我们有足够的检查来发出实际的存储。

```python
@adaptive
fn memset_autotune_impl(ptr: BufferPtrType, value: ValueType, count: Int, /):
    memset_impl_layer[-100, 100](ptr, value, count)
```

我们完成了memset的实现，现在我们只需要将其连接到自动调优基础设施，让 Mojo 编译器进行搜索并选择最佳的实现。

要做到这一点，我们需要定义一个评估器 - 这是一个函数，它将接受一个包含所有实现我们函数的函数指针数组，并需要返回最佳候选的索引。

这个函数的实现没有限制 - 它可以返回第一个或随机的候选者，或者实际上可以对它们进行基准测试并选择最快的 - 这就是我们在这个例子中要做的事情。

```python
fn memset_evaluator(funcs: Pointer[memset_fn_type], size: Int) -> Int:
    # This size is picked at random, in real code we could use a real size
    # distribution here.
    let size_to_optimize_for = 17
    print(size_to_optimize_for)

    var best_idx: Int = -1
    var best_time: Int = -1

    alias eval_iterations = MULT
    alias eval_samples = 500

    # Find the function that's the fastest on the size we're optimizing for
    for f_idx in range(size):
        let func = funcs.load(f_idx)
        let cur_time = measure_time(
            func, size_to_optimize_for, eval_iterations, eval_samples
        )
        if best_idx < 0:
            best_idx = f_idx
            best_time = cur_time
        if best_time > cur_time:
            best_idx = f_idx
            best_time = cur_time

    return best_idx
```

评估器已经准备好了，最后一步是添加一个函数来调用最佳候选者。

在运行时，我们将直接使用最佳实现来进行搜索。

```python
fn memset_autotune(ptr: BufferPtrType, value: ValueType, count: Int):
    # Get the set of all candidates
    alias candidates = memset_autotune_impl.__adaptive_set

    # Use the evaluator to select the best candidate.
    alias best_impl: memset_fn_type
    search[memset_fn_type, VariadicList(candidates), memset_evaluator -> best_impl]()

    # Run the best candidate
    return best_impl(ptr, value, count)
```

现在我们准备好对我们的函数进行基准测试了，让我们看看它的性能如何！

```python
benchmark(memset_manual, "Mojo manual memset")
benchmark(memset_manual_2, "Mojo manual memset v2")
benchmark(memset_system, "Mojo system memset")
benchmark(memset_autotune, "Mojo autotune memset")
```

```
=====================
Mojo manual memset
---------------------

Size:  0   |******************************************
Size:  1   |******************************************
Size:  2   |******************************************
Size:  3   |******************************************
Size:  4   |******************************************
Size:  5   |***************************************************
Size:  6   |***************************************************
Size:  7   |***************************************************
Size:  8   |******************************************
Size:  9   |******************************************
Size: 10   |******************************************
Size: 11   |******************************************
Size: 12   |******************************************
Size: 13   |******************************************
Size: 14   |******************************************
Size: 15   |******************************************
Size: 16   |******************************************
Size: 17   |************************************************************
Size: 18   |************************************************************
Size: 19   |************************************************************
Size: 20   |************************************************************
Size: 21   |************************************************************
Size: 22   |************************************************************
Size: 23   |************************************************************
Size: 24   |************************************************************
Size: 25   |************************************************************
Size: 26   |************************************************************
Size: 27   |************************************************************
Size: 28   |************************************************************
Size: 29   |************************************************************
Size: 30   |************************************************************
Size: 31   |************************************************************
Size: 32   |********************************************************************
Size: 33   |********************************************************************
Size: 34   |********************************************************************

=====================
Mojo manual memset v2
---------------------

Size:  0   |************************************************************
Size:  1   |************************************************************
Size:  2   |************************************************************
Size:  3   |***************************************************
Size:  4   |***************************************************
Size:  5   |************************************************************
Size:  6   |************************************************************
Size:  7   |************************************************************
Size:  8   |***************************************************
Size:  9   |***************************************************
Size: 10   |***************************************************
Size: 11   |***************************************************
Size: 12   |***************************************************
Size: 13   |***************************************************
Size: 14   |***************************************************
Size: 15   |***************************************************
Size: 16   |**********************************
Size: 17   |**********************************
Size: 18   |**********************************
Size: 19   |**********************************
Size: 20   |**********************************
Size: 21   |**********************************
Size: 22   |**********************************
Size: 23   |**********************************
Size: 24   |**********************************
Size: 25   |**********************************
Size: 26   |**********************************
Size: 27   |**********************************
Size: 28   |**********************************
Size: 29   |**********************************
Size: 30   |**********************************
Size: 31   |**********************************
Size: 32   |********************************************************************
Size: 33   |********************************************************************
Size: 34   |********************************************************************

=====================
Mojo system memset
---------------------

Size:  0   |************************************************************
Size:  1   |************************************************************
Size:  2   |************************************************************
Size:  3   |************************************************************
Size:  4   |************************************************************
Size:  5   |************************************************************
Size:  6   |************************************************************
Size:  7   |************************************************************
Size:  8   |************************************************************
Size:  9   |************************************************************
Size: 10   |************************************************************
Size: 11   |************************************************************
Size: 12   |************************************************************
Size: 13   |************************************************************
Size: 14   |************************************************************
Size: 15   |************************************************************
Size: 16   |************************************************************
Size: 17   |************************************************************
Size: 18   |************************************************************
Size: 19   |************************************************************
Size: 20   |************************************************************
Size: 21   |************************************************************
Size: 22   |************************************************************
Size: 23   |************************************************************
Size: 24   |************************************************************
Size: 25   |************************************************************
Size: 26   |************************************************************
Size: 27   |************************************************************
Size: 28   |************************************************************
Size: 29   |************************************************************
Size: 30   |************************************************************
Size: 31   |************************************************************
Size: 32   |***************************************************
Size: 33   |***************************************************
Size: 34   |***************************************************

=====================
Mojo autotune memset
---------------------

Size:  0   |************************************************************
Size:  1   |********************************************************************
Size:  2   |********************************************************************
Size:  3   |************************************************************
Size:  4   |************************************************************
Size:  5   |***************************************************
Size:  6   |***************************************************
Size:  7   |***************************************************
Size:  8   |***************************************************
Size:  9   |***************************************************
Size: 10   |***************************************************
Size: 11   |***************************************************
Size: 12   |***************************************************
Size: 13   |***************************************************
Size: 14   |***************************************************
Size: 15   |***************************************************
Size: 16   |***************************************************
Size: 17   |**********************************
Size: 18   |**********************************
Size: 19   |**********************************
Size: 20   |**********************************
Size: 21   |**********************************
Size: 22   |**********************************
Size: 23   |**********************************
Size: 24   |**********************************
Size: 25   |**********************************
Size: 26   |**********************************
Size: 27   |**********************************
Size: 28   |**********************************
Size: 29   |**********************************
Size: 30   |**********************************
Size: 31   |**********************************
Size: 32   |**********************************
Size: 33   |********************************************************************
Size: 34   |********************************************************************
```
